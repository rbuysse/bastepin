<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Keys</title>
    <style>
      body {
        margin: 0;
        font-family: monospace;
        background: #0d1117;
        color: #c9d1d9;
        padding: 20px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #30363d;
      }

      h1 {
        margin: 0;
        color: #58a6ff;
      }

      .btn {
        padding: 8px 16px;
        background: #238636;
        border: 1px solid #2ea043;
        color: white;
        text-decoration: none;
        cursor: pointer;
        font-family: monospace;
      }

      .btn:hover {
        background: #2ea043;
      }

      .btn-danger {
        background: #da3633;
        border-color: #f85149;
      }

      .btn-danger:hover {
        background: #f85149;
      }

      .key-list {
        list-style: none;
        padding: 0;
      }

      .key-item {
        background: #161b22;
        border: 1px solid #30363d;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .key-info {
        flex: 1;
      }

      .key-name {
        color: #58a6ff;
        font-weight: bold;
        font-size: 15px;
      }

      .key-meta {
        color: #8b949e;
        font-size: 13px;
        margin-top: 5px;
      }

      .no-keys {
        text-align: center;
        color: #8b949e;
        margin-top: 50px;
      }

      .create-form {
        background: #161b22;
        border: 1px solid #30363d;
        padding: 20px;
        margin-bottom: 20px;
      }

      .create-form label {
        display: block;
        margin-bottom: 10px;
      }

      .create-form input, .create-form select {
        padding: 8px;
        background: #0d1117;
        border: 1px solid #30363d;
        color: #c9d1d9;
        font-family: monospace;
        margin-left: 10px;
      }

      .key-value {
        background: #0d1117;
        padding: 10px;
        border: 1px solid #30363d;
        font-family: monospace;
        margin-top: 10px;
        word-break: break-all;
        color: #58a6ff;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>ðŸ”‘ API Keys - {{ .Username }}</h1>
      <a href="/" class="btn">Back to Home</a>
    </div>

    <div class="create-form">
      <h3>Create New API Key</h3>
      <label>
        Name: <input type="text" id="key-name" placeholder="My API Key" />
      </label>
      <label>
        Expires:
        <select id="expires-in-days">
          <option value="">Never</option>
          <option value="7">7 days</option>
          <option value="30">30 days</option>
          <option value="90">90 days</option>
          <option value="365">1 year</option>
        </select>
      </label>
      <button class="btn" onclick="createAPIKey()">Create API Key</button>
      <div id="new-key-result"></div>
    </div>

    {{ if .Keys }}
      <h3>Your API Keys</h3>
      <ul class="key-list">
        {{ range .Keys }}
          <li class="key-item">
            <div class="key-info">
              <div class="key-name">{{ .Name }}</div>
              <div class="key-meta">
                Created: {{ .CreatedAt.Format "2006-01-02 15:04:05" }}
                {{ if .ExpiresAt }}
                  â€¢ Expires: {{ .ExpiresAt.Format "2006-01-02 15:04:05" }}
                {{ else }}
                  â€¢ Never expires
                {{ end }}
                {{ if .LastUsed }}
                  â€¢ Last used: {{ .LastUsed.Format "2006-01-02 15:04:05" }}
                {{ else }}
                  â€¢ Never used
                {{ end }}
              </div>
            </div>
            <button class="btn btn-danger" onclick="deleteAPIKey({{ .ID }})">Delete</button>
          </li>
        {{ end }}
      </ul>
    {{ else }}
      <div class="no-keys">
        <p>No API keys yet. Create one above!</p>
      </div>
    {{ end }}

    <script>
      async function createAPIKey() {
        const name = document.getElementById('key-name').value.trim();
        const expiresInDaysValue = document.getElementById('expires-in-days').value;
        const expiresInDays = expiresInDaysValue ? parseInt(expiresInDaysValue) : null;

        if (!name) {
          alert('Please enter a name for the API key');
          return;
        }

        try {
          const response = await fetch('/api/keys/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, expires_in_days: expiresInDays })
          });

          if (response.ok) {
            const apiKey = await response.json();
            document.getElementById('new-key-result').innerHTML = `
              <div style="margin-top: 15px; padding: 15px; background: #2ea043; border: 1px solid #238636; color: white;">
                <strong>API Key Created!</strong><br>
                <em>Copy this key now - you won't be able to see it again!</em>
                <div class="key-value">${apiKey.Key}</div>
              </div>
            `;
            setTimeout(() => window.location.reload(), 5000);
          } else {
            alert('Failed to create API key');
          }
        } catch (error) {
          alert('Failed to create API key: ' + error);
        }
      }

      async function deleteAPIKey(keyId) {
        if (!confirm('Are you sure you want to delete this API key? This action cannot be undone.')) {
          return;
        }

        try {
          const response = await fetch('/api/keys/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: keyId })
          });

          if (response.ok) {
            window.location.reload();
          } else {
            alert('Failed to delete API key');
          }
        } catch (error) {
          alert('Failed to delete API key: ' + error);
        }
      }
    </script>
  </body>
</html>
